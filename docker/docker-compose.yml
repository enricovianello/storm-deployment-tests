version: '3.5'

volumes:
  trustanchors:
  storage:
  gridmapdir:

networks:
  example:
    name: example

services:

  trust:
    container_name: trust
    image: indigoiam/trustanchors
    environment:
      - FORCE_TRUST_ANCHORS_UPDATE=1
    volumes:
      - trustanchors:/etc/grid-security/certificates

  redis-server:
    container_name: redis
    dns_search: example
    hostname: redis-server.example
    image: redis:latest
    networks:
      example:
        aliases:
          - redis-server.example

  cdmi-storm:
    image: italiangrid/cdmi-storm
    build:
      context: ./cdmi-storm
    container_name: cdmi
    dns_search: example
    hostname: cdmi-storm.example
    depends_on:
      - redis-server
      - storm
    environment:
      - MODE=clean
      - REDIS_HOSTNAME=redis-server.example
      - PLATFORM=centos6
      - CDMI_CLIENT_SECRET
    networks:
      example:
        aliases:
          - cdmi-storm.example

  storm-testsuite:
    image: italiangrid/storm-testsuite
    build:
      context: ./storm-testsuite
    container_name: testsuite
    dns_search: example
    hostname: storm-testsuite.example
    entrypoint: sh /assets/run_testsuite.sh
    environment:
      - TESTSUITE_BRANCH
      - TESTSUITE_EXCLUDE
      - TESTSUITE_SUITE
      - VOMS_FAKE
      - CDMI_CLIENT_SECRET
      - IAM_USER_PASSWORD
      - DAV_HOST
      - SRM_HOST
    depends_on:
      - storm
      - cdmi-storm
      - trust
      - tfnode
    volumes:
      - trustanchors:/etc/grid-security/certificates
      - ./storm-testsuite/assets:/assets
    networks:
      example:
        aliases:
          - storm-testsuite.example

  storm:
    image: italiangrid/storm-deployment:centos6
    build:
      context: ./storm-deployment
      dockerfile: Dockerfile.centos6
    container_name: storm
    dns_search: example
    hostname: storm.example
    entrypoint: /bin/bash /assets/deploy.sh
    environment:
      - UPGRADE_FROM
      - TARGET_RELEASE
    ports:
      - 8080:8080
      - 8444:8444
      - 9998:9998
      - 2710:2710
    depends_on:
      - trust
    volumes:
      - trustanchors:/etc/grid-security/certificates
      - ./storm-deployment/assets:/assets
      - storage:/storage
      - gridmapdir:/etc/grid-security/gridmapdir
    networks:
      example:
        aliases:
          - storm.example

  tfnode:
    image: italiangrid/storm-tfnode
    build:
      context: ./tf-node
    container_name: tfnode
    dns_search: example
    hostname: storm-alias.example
    ports:
      - 8085:8085
      - 8443:8443
      - 2811:2811
    depends_on:
      - trust
    volumes:
      - trustanchors:/etc/grid-security/certificates
      - ./tf-node/assets:/assets
      - storage:/storage
      - gridmapdir:/etc/grid-security/gridmapdir
    cap_add:
      - SYS_ADMIN
    networks:
      example:
        aliases:
          - storm-alias.example
